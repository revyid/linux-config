#!/bin/bash
set -e

echo "==> Update system & install base packages..."
sudo pacman -Syu --noconfirm
sudo pacman -S --noconfirm \
  zsh git curl wget \
  bat exa fd ripgrep neovim \
  ttf-meslo-nerd

echo "==> Install Oh My Zsh..."
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  RUNZSH=no CHSH=no sh -c \
    "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

ZSH_CUSTOM="$HOME/.oh-my-zsh/custom"

echo "==> Install plugins..."
git clone https://github.com/zsh-users/zsh-autosuggestions \
  "$ZSH_CUSTOM/plugins/zsh-autosuggestions" 2>/dev/null || true

git clone https://github.com/zsh-users/zsh-syntax-highlighting \
  "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" 2>/dev/null || true

git clone https://github.com/zsh-users/zsh-completions \
  "$ZSH_CUSTOM/plugins/zsh-completions" 2>/dev/null || true

echo "==> Install Powerlevel10k..."
git clone --depth=1 https://github.com/romkatv/powerlevel10k.git \
  "$ZSH_CUSTOM/themes/powerlevel10k" 2>/dev/null || true

echo "==> Configure .zshrc..."
cat > ~/.zshrc << 'EOF'
# =========================
# ZSH FULL CONFIG
# =========================

# ---- p10k instant prompt ----
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"

plugins=(
  git
  zsh-autosuggestions
  zsh-syntax-highlighting
  zsh-completions
)

source $ZSH/oh-my-zsh.sh

# ---- Performance ----
DISABLE_AUTO_UPDATE="true"
ENABLE_CORRECTION="false"
COMPLETION_WAITING_DOTS="false"

# ---- History ----
HISTSIZE=20000
SAVEHIST=20000
HISTFILE=~/.zsh_history
setopt SHARE_HISTORY
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_SAVE_NO_DUPS
setopt INC_APPEND_HISTORY

# ---- Completion ----
autoload -Uz compinit
compinit
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'

# ---- Aliases ----
alias cls='clear'
alias ll='exa -lah --icons'
alias la='exa -a --icons'
alias cat='bat'
alias find='fd'
alias grep='rg'

alias gs='git status'
alias ga='git add .'
alias gc='git commit -m'
alias gp='git push'
alias gl='git log --oneline --graph --decorate'

alias upd='sudo pacman -Syu'
alias ins='sudo pacman -S'
alias rem='sudo pacman -Rns'

# ---- Keybind ----
bindkey '^[[H' beginning-of-line
bindkey '^[[F' end-of-line
bindkey '^R' history-incremental-search-backward

# ---- Env ----
export EDITOR=nvim
export VISUAL=nvim
export PATH="$HOME/.local/bin:$PATH"

# ---- p10k config ----
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh
EOF

echo "==> Set Zsh as default shell..."
if [ "$SHELL" != "$(which zsh)" ]; then
  chsh -s "$(which zsh)"
fi

echo "==> DONE!"
echo "Restart terminal, lalu jalankan: p10k configure"
